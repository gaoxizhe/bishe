<!DOCTYPE html>
<html class="x-admin-sm" xmlns:th="http://www.thymeleaf.org" lang="ch">
<head th:replace="/admin/common::head"></head>
<link rel="stylesheet" th:href="@{/css/style.css}"/>
<link rel="stylesheet" th:href="@{/css/editormd.css}"/>
<!--<link rel="stylesheet" th:href="@{/css/editormd.logo.css}"/>-->
<!--<link rel="stylesheet" th:href="@{/css/editormd.preview.css}"/>-->

<!--<link rel="shortcut icon" href="https://pandao.github.io/editor.md/favicon.ico" type="image/x-icon"/>-->

<body>
<div class="x-nav">
    <span class="layui-breadcrumb" style="float: left">
        <a href="">文章</a>
        <a><cite>发布文章</cite></a>
    </span>
    <a class="layui-btn layui-btn-small" style="line-height:1.6em;margin-top:3px;float:right"
       onclick="location.reload()" title="刷新">
        <i class="layui-icon layui-icon-refresh" style="line-height:30px"></i>
    </a>
</div>
<div style="height: 29px"></div>
<div class="layui-fluid">
    <div id="layout">
        <div id="test-editormd">
                <textarea th:utext="${ null != content ? content.getContentMd() : null}"></textarea>
        </div>
    </div>
    <form class="layui-form layui-form-pane" action="">
        <input type="hidden" name="id" th:value="${ null != content ? content.getId() : null}"  />
        <div class="layui-form-item layui-col-md12" style="margin-top: 30px">
            <div class="" style="width: 90%;margin-left: 5%">
                    <input type="text" name="title" required lay-verify="required" placeholder="请输入文章标题" autocomplete="off"
                           class="layui-input" th:value="${ null != content ? content.getTitle() : null}">
            </div>
        </div>


        <div class="layui-form-item layui-col-md12">
            <div class="" style="width: 90%;margin-left: 5%">
                <input type="text" name="introduction" placeholder="请输入文章简介"
                       class="layui-input" th:value="${ null != content ? content.getIntroduction() : null}">
            </div>
        </div>


        <div style="width: 400px;margin-left: 5%" class="layui-form-item">
            <label class="layui-form-label">分类</label>
            <div class="layui-input-block">
                <select name="category" >
                    <option value="">--请选择--</option>
                    <option th:each="category : ${categoryList}" th:value="${category.getId()}"
                            th:text="${category.getName()}"
                            th:selected="${ null != content  && content.getCategoryId() == category.getId()? true : false}"></option>
                </select>
            </div>
        </div>
        <div style="width: 90%;margin-left: 5%" class="layui-form-item" pane>
            <label class="layui-form-label">标签</label>
            <div class="layui-input-block">
                <div style="float: left">
                    <input th:each="label : ${labelList}" type="checkbox" name="label" th:title="${label.getName()}"
                           th:value="${label.getId()}"
                           th:checked="${ null != content  && content.getLabelIds().contains(label.getId()) ? 'checked' : false}"
                           lay-filter="filter">
                </div>
            </div>
        </div>
        <div class="layui-form-item" style="width: 90%;margin-left: 5%">
            <label class="layui-form-label">评论</label>
            <div class="layui-input-block">
                <div style="float: left">
                    <input type="checkbox" name="comment" lay-skin="switch" value="1" lay-text="开启|关闭"
                           th:checked="${ null != content  && content.getIsComment()==1  ? '' : false}"
                    >
                </div>
            </div>
        </div>

        <div class="layui-form-item" style="width: 90%;margin-left: 5%">
            <label class="layui-form-label">是否公开</label>
            <div class="layui-input-block" style="width: 80px">
                <div style="float: left">
                    <input type="checkbox" name="open" lay-skin="switch" value="1" lay-text="开启|关闭"
                           th:checked="${ null != content  && content.getIsOpen()==1  ? '' : false}">
                </div>
            </div>
        </div>
        <div style="width: 90%;margin-left: 5%;">
            <div style="float:right">
                <button type="button" class="layui-btn layui-btn-radius layui-btn-primary" onclick="toIndex()">
                    <i class="layui-icon layui-icon-left"></i>
                    返回 &nbsp;&nbsp;&nbsp;&nbsp;
                </button>
                <button lay-submit lay-filter="*" type="submit" class="layui-btn layui-btn-radius">发布博客</button>
                <button lay-submit lay-filter="draft" type="submit" class="layui-btn layui-btn-radius layui-btn-normal">
                    保存为草稿
                </button>
            </div>
        </div>
    </form>


    <script th:src="@{/js/jquery.min.js}"></script>
    <script th:src="@{/js/editormd.js}"></script>
    <!--    <script th:src="@{/lib/marked.min.js}"></script>-->
    <!--    <script th:src="@{/lib/prettify.min.js}"></script>-->
    <!--    <script th:src="@{/lib/raphael.min.js}"></script>-->
    <!--    <script th:src="@{/lib/underscore.min.js}"></script>-->
    <!--    <script th:src="@{/lib/sequence-diagram.min.js}"></script>-->
    <!--    <script th:src="@{/lib/flowchart.min.js}"></script>-->
    <!--    <script th:src="@{/lib/jquery.flowchart.min.js}"></script>-->

    <script>


    </script>
    <script type="text/javascript">
        var testEditor;

        $(function () {


            testEditor = editormd("test-editormd", {
                width: "90%",
                height: 600,
                path: '/lib/',
                // theme: "dark",
                // previewTheme: "dark",
                // editorTheme: "pastel-on-dark",

                fcodeFold: false,
                syncScrolling: true,
                saveHTMLToTextarea: true,    // 保存 HTML 到 Textarea
                searchReplace: true,
                //watch : false,                // 关闭实时预览
                htmlDecode: "style,script,iframe|on*",            // 开启 HTML 标签解析，为了安全性，默认不开启
                //toolbar  : false,             //关闭工具栏
                //previewCodeHighlight : false, // 关闭预览 HTML 的代码块高亮，默认开启
                emoji: true,
                taskList: true,
                tocm: true,         // Using [TOCM]
                tex: true,                   // 开启科学公式TeX语言支持，默认关闭
                flowChart: true,             // 开启流程图支持，默认关闭
                sequenceDiagram: true,       // 开启时序/序列图支持，默认关闭,
                //dialogLockScreen : false,   // 设置弹出层对话框不锁屏，全局通用，默认为true
                //dialogShowMask : false,     // 设置弹出层对话框显示透明遮罩层，全局通用，默认为true
                //dialogDraggable : false,    // 设置弹出层对话框不可拖动，全局通用，默认为true
                //dialogMaskOpacity : 0.4,    // 设置透明遮罩层的透明度，全局通用，默认值为0.1
                //dialogMaskBgColor : "#000", // 设置透明遮罩层的背景颜色，全局通用，默认为#fff
                imageUpload: true,
                imageFormats: ["jpg", "jpeg", "gif", "png", "bmp", "webp"],
                imageUploadURL: "/admin/file/upload",
                onload: function () {
                    console.log('onload', this);
                    //this.fullscreen();
                    //this.unwatch();
                    //this.watch().fullscreen();

                    //this.setMarkdown("#PHP");
                    //this.width("100%");
                    //this.height(480);
                    //this.resize("100%", 640);
                }
            });
        });
        layui.use(['form', 'layer', 'table', 'util', 'element'],


            function () {
                let table = layui.table;
                let util = layui.util;
                let layer = layui.layer;
                let form = layui.form;
                $ = layui.$;

                let arr_box = [];


                form.on('checkbox(filter)', function (data) {
                    arr_box = [];
                    console.log(data.elem); //得到checkbox原始DOM对象
                    console.log(data.elem.checked); //是否被选中，true或者false
                    console.log(data.value); //复选框value值，也可以通过data.elem.value得到
                    console.log(data.othis); //得到美化后的DOM对象
                    $('input[name="label"]:checked').each(function () {
                        arr_box.push($(this).val());
                    });
                    //数组
                    console.log("arr_box" + arr_box);
                });

                form.on('submit(*)', function (data) {
                    arr_box = [];
                    $('input[name="label"]:checked').each(function () {
                        arr_box.push($(this).val());
                    });

                    //数组
                    console.log(data.elem) //被执行事件的元素DOM对象，一般为button对象
                    console.log(data.form) //被执行提交的form对象，一般在存在form标签时才会返回
                    console.log(data.field) //当前容器的全部表单字段，名值对形式：{name: value}
                    console.log("arr_box" + JSON.stringify(arr_box));

                    let submitData = {
                        'id': data.field.id,
                        'title': data.field.title,
                        'contentMd': testEditor.getMarkdown(),
                        'contentHtml': testEditor.getHTML(),
                        'introduction': data.field.introduction,
                        'categoryId': data.field.category,
                        'clickNum': 0,
                        'commentsNum': 0,
                        'isComment': data.field.comment ? data.field.comment : 0,
                        'isOpen': data.field.open ? data.field.open : 0,
                        'isDraft': 0,
                        'labelIds': arr_box
                    };

                    $.ajax({
                        url: "/admin/content/add",
                        type: 'POST',
                        dataType: "json",
                        contentType: "application/json", //必须这样写
                        traditional: true,
                        data: JSON.stringify(submitData),
                        success: function (data) {

                            if (data.code != 0) {
                                layer.msg(data.msg, {icon: 5});
                            } else {
                                layer.msg('发布成功');
                                setInterval(function () {
                                    xadmin.del_tab();
                                }, 2000);
                            }
                        },
                        error: function (data) {
                            layer.msg('错误', {icon: 5});
                        }
                    });

                    return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
                });
                form.on('submit(draft)', function (data) {
                    arr_box = [];
                    $('input[name="label"]:checked').each(function () {
                        arr_box.push($(this).val());
                    });
                    let submitData = {
                        'id': data.field.id,
                        'title': data.field.title,
                        'contentMd': testEditor.getMarkdown(),
                        'contentHtml': testEditor.getHTML(),
                        'introduction': data.field.introduction,
                        'categoryId': data.field.category,
                        'clickNum': 0,
                        'commentsNum': 0,
                        'isComment': data.field.comment ? data.field.comment : 0,
                        'isOpen': data.field.open ? data.field.open : 0,
                        'isDraft': 1,
                        'labelIds': arr_box
                    };
                    $.ajax({
                        url: "/admin/content/add",
                        type: 'POST',
                        dataType: "json",
                        contentType: "application/json", //必须这样写
                        traditional: true,
                        data: JSON.stringify(submitData),
                        success: function (data) {

                            if (data.code != 0) {
                                layer.msg(data.msg, {icon: 5});
                            } else {
                                layer.msg('保存成功');
                                setInterval(function () {
                                    xadmin.del_tab();
                                }, 2000);
                            }
                        },
                        error: function (data) {
                            layer.msg('错误', {icon: 5});
                        }
                    });

                    return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
                });

            });

        window.toIndex = function () {
            xadmin.del_tab();
            xadmin.father_reload()
        }

    </script>
</div>
</body>


</html>